{% extends "base.html" %}

{% block site-title %}
    <title>My.jobs - Reports - {{ company.name }} (beta)</title>
    <meta name="title" content="My.jobs - Reports - {{ company.name }}">
{% endblock %}

{% block meta-extra %}
<link rel="stylesheet" href="{{STATIC_URL}}pickadate/themes/classic.css" id="theme_base">
<link rel="stylesheet" href="{{STATIC_URL}}pickadate/themes/classic.date.css" id="theme_date">
<link rel="stylesheet" href="{{STATIC_URL}}font-awesome.css">
{% endblock %}

{% block content %}
    <div class="row">
        <div class="span12">
            <h1 class="bottom-bordered">{{ company.name }} <small>Dynamic Reports (beta)</small></h1>
        </div>
    </div>
    <!-- This UI is a placeholder for QA purposes.
         It is not intended to set any precedent. -->
    <h3>Walk through report types API</h3>
    <div id="select-container" class="row">
        <div class="span12">
            <div id="select-content"></div>
        </div>
    </div>

    <div class="row">
        <div class="span12">
            <ul id='report-links-list'></ul>
        </div>
    </div>
{% endblock %}

{% block extra-js %}
{% autoescape off %}
<script type="text/javascript">
    var states = {{ states }};
</script>
<script type="text/javascript">
var csrf = read_cookie("csrftoken");

function ajaxRunReport(rpId) {
    return $.ajax({
        url: "/reports/api/run_report",
        type: "POST",
        dataType: "json",
        data: {csrfmiddlewaretoken: csrf,
            rp_id: rpId},
        withCredentials: true,
    });
}

function resetReportingTypes() {
    ajaxReportingTypes().done(function(data) {
        domReportingTypes(data);
    }).fail(function(xhr, text, error) { console.error(text, error, xhr); });
}

function ajaxReportingTypes() {
    return $.ajax({
        url: "/reports/api/reporting_types",
        type: "POST",
        dataType: "json",
        data: {csrfmiddlewaretoken: csrf},
        withCredentials: true,
    });
}

function ajaxReportTypes(reportingType) {
    return $.ajax({
        url: "/reports/api/report_types",
        type: "POST",
        dataType: "json",
        data: {csrfmiddlewaretoken: csrf,
               reporting_type_id: reportingType},
        withCredentials: true,
    });
}

function ajaxDataTypes(reportType) {
    return $.ajax({
        url: "/reports/api/data_types",
        type: "POST",
        dataType: "json",
        data: {csrfmiddlewaretoken: csrf,
               report_type_id: reportType},
        withCredentials: true,
    });
}

function ajaxReportPresentations(reportType, dataType) {
    return $.ajax({
        url: "/reports/api/report_presentations",
        type: "POST",
        dataType: "json",
        data: {csrfmiddlewaretoken: csrf,
               data_type_id: dataType,
               report_type_id: reportType},
        withCredentials: true,
    });
}

function domButtonRow(buttonText, text, onclick) {
    var linkDom = $('<div class="span3" style="text-align: right"><a class="btn" href="#">' + buttonText + '</a></div>');
    linkDom.on('click', onclick);
    var dom = $('<div class="row"></div>');
    dom.append(linkDom);
    dom.append('<div class="span4">' + text + '</div>');
    dom.on('onclick', onclick);
    return dom;
}

function domReportingTypes(data) {
    $('#select-content').empty();
    $.each(data['reporting_type'], function(rtId, rt) {
        function onclick() {
            ajaxReportTypes(rtId).done(function(rt) {
                domReportTypes(rt);
            }).fail(function(xhr, text, error) { console.error(text, error, xhr); });
            return false;
        };
        var dom = domButtonRow(rt['name'], rt['description'], onclick);
        $('#select-content').append(dom);
        $('#select-container').show();
    });
}

function domReportTypes(data) {
    $('#select-content').empty();
    $.each(data['report_type'], function(rtId, rt) {
        function onclick() {
            ajaxDataTypes(rtId).done(function(dt) {
                domDataTypes(dt, rtId);
            }).fail(function(xhr, text, error) { console.error(text, error, xhr); });
            return false;
        };
        var dom = domButtonRow(rt['name'], rt['description'], onclick);
        $('#select-content').append(dom);
        $('#select-container').show();
    });
}

function domDataTypes(data, rtId) {
    $('#select-content').empty();
    $.each(data['data_type'], function(dtId, dt) {
        function onclick() {
            ajaxReportPresentations(rtId, dtId).done(function(rp) {
                domReportPresentations(rp);
            }).fail(function(xhr, text, error) { console.error(text, error, xhr); });
            return false;
        };
        var dom = domButtonRow(dt['name'], dt['description'], onclick);
        $('#select-content').append(dom);
        $('#select-container').show();
    });
}

function domReportPresentations(data) {
    $('#select-content').empty();
    $.each(data['report_presentation'], function(rpId, rp) {
        function onclick() {
            ajaxRunReport(rpId).done(function(dr) {
                domRunReport(dr);
            }).fail(function(xhr, text, error) { console.error(text, error, xhr); });
            return false;
        };
        var dom = domButtonRow(rp['name'], rp['name'], onclick);
        $('#select-content').append(dom);
        $('#select-container').show();
    });
}

function domRunReport(data) {
    var reportId = data['id'];
    var list = $('#report-links-list');
    var href = '/reports/view/dynamicdownload?id=' + reportId;
    var dom = $('<li><a href="' + href + '">Report: ' + reportId + '</a></li>');
    list.append(dom);

    domYay("report presentation", reportId);

}

function domYay(label, rtId) {
    $('#select-content').empty();
    function onclick() {
        resetReportingTypes();
    };
    var dom = domButtonRow('Reset', 'Done with ' + label
                           + ' id:' + rtId, onclick);
    $('#select-content').append(dom);
    $('#select-container').show();

};

$(document).on('ready', function() {
    resetReportingTypes();
});
</script>
{% endautoescape %}
<!--[if IE]>
<script src="{{ STATIC_URL }}es5-sham.min.js"></script>
<![endif]-->
<script src="{{ STATIC_URL }}bootstrap/bootstrap-modalmanager.js"></script>
<script src="{{ STATIC_URL }}bootstrap/bootstrap-modal.js"></script>
<script src="{{ STATIC_URL }}reporting.167-25.js"></script>
<script src="{{ STATIC_URL }}pickadate/picker.js"></script>
<script src="{{ STATIC_URL }}pickadate/picker.date.js"></script>
<script src="{{ STATIC_URL }}pickadate/legacy.js"></script>
<!-- SteelToe: https://github.com/jclem/steeltoe -->
<script src="{{ STATIC_URL }}steeltoe.js"></script>
{% endblock %}
