<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ETL Imports &mdash; My.jobs 4.6.158-13 documentation</title>
    
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '4.6.158-13',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="My.jobs 4.6.158-13 documentation" href="../../index.html" />
    <link rel="up" title="Imports Documentation" href="index.html" />
    <link rel="next" title="Deployment Checklist" href="../deployment/checklist.html" />
    <link rel="prev" title="Imports Documentation" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../deployment/checklist.html" title="Deployment Checklist"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Imports Documentation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">My.jobs 4.6.158-13 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Developer Documentation</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Imports Documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="etl-imports">
<h1>ETL Imports<a class="headerlink" href="#etl-imports" title="Permalink to this headline">¶</a></h1>
<p>There are two main types of failures for etl imports.  General failures which affect all or a asignificant number of imports, or individual failures which affect only one business unit.  The former usually point to an issue in our codebase or our backend systems.  The latter most often result from receiving malformed xml when we attempt to import a job.</p>
<div class="section" id="etl-import-process">
<h2>ETL Import Process:<a class="headerlink" href="#etl-import-process" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Create BusinessUnit and Company</li>
<li>Get ZIP file from jobsfs</li>
<li>Get XML documents from zip file</li>
<li>Filter out jobs that shouldn&#8217;t go onto our site</li>
<li>Convert from XML to dict for uploading to solr.  Also transform import data to common output.</li>
<li>Add redirects for jobs to database.</li>
<li>Add jobs to solr</li>
<li>Remove old jobs from solr.</li>
<li>Update business unit job count.</li>
</ol>
</div>
<div class="section" id="debugging-general-failures">
<h2>Debugging General Failures:<a class="headerlink" href="#debugging-general-failures" title="Permalink to this headline">¶</a></h2>
<p>Determine root cause of failures.  Typically, there are 4 places where it can fail.  Determining where it is failing will generally point you into the right direction for fixing it.</p>
<ol class="arabic">
<li><p class="first"><strong>Failing while trying to download the ZIP file</strong>.  This points to issues with the network or JobsFS.  The first step should be to attempt to download a zip file from jobsfs.directemployers.org/.  You will need a username and password that is available in the secrets file.</p>
<blockquote>
<div><ol class="arabic simple">
<li><strong>If you cannot access that server</strong>, this points to an issue with the server itself.  Check with Mario and/or Kyle to see if they can access the system over samba.  Speak with Lou about network access and checking on the network proxy.  Continue to work with them and debug as a server issue.</li>
<li><strong>If you can access the server locally</strong>, ssh to a worker box, and attempt to download a file via wget.  If that fails, compare ping addresses for jobsfs.directemployers.org between your box and the worker box, to ensure you&#8217;re not having DNS resolution issues.  Attempt to download a general file or webpage from somewhere to ensure you have general network connectivity.  If you are able to download a file via wget, as user ubuntu &#8216;<code class="docutils literal"><span class="pre">cd</span> <span class="pre">/home/web/MyJobs/MyJobs/</span></code>&#8216; and <a class="reference internal" href="#run-a-task-manually">run a task manually</a>.  Review the exception raised at this point, and begin to debug.  You&#8217;ve reached the end of predictable failures.</li>
</ol>
</div></blockquote>
</li>
<li><p class="first"><strong>Failing while trying to load XML documents</strong>.  This points to an issue with the contents of the ZIP files.  This may be that the zipfiles themselves are malformed, or that we are unable to handle some common piece of data from the XML files.</p>
<blockquote>
<div><ol class="arabic simple">
<li><strong>Validate the ZIP file is well formed</strong>.  Download a ZIP file locally and validate that you can open and browse the files in the ZIP file.  If this fails, let Mario or Kyle know about the failure, and let them examine the ZIP file.</li>
<li><strong>Validate the XML documents are well formed</strong>.  If the failure is affecting multiple business units, but the ZIP file appears to be well formed when you download it, run one of the xml files through a XML validator. If this fails, let Mario or Kyle know about the failure, and ask them to review the XML document.</li>
<li><strong>Review error raised by lxml</strong>.  If it validates successfully, <a class="reference internal" href="#run-a-task-manually">run a task manually</a> and review the exception raised during XML parsing.  Sometimes lxml, the python xml library fails to handle things correctly.  Review the results of running the task to determine the file, and examine it manually for anything that seems out of place.</li>
</ol>
</div></blockquote>
</li>
<li><p class="first"><strong>Failure to parse XML documents</strong>.  After we&#8217;ve successfully built an ElementTree Object from the XML document, we parse it to build a dictionary object to send to solr.  During this process, we extract several pieces of data from the ElementTree, cast some of them to other data types, and then do a variety of manipulations on them to build the solr document.</p>
<blockquote>
<div><ol class="arabic simple">
<li><strong>Review errors raised during transformation</strong>.  locally, <a class="reference internal" href="#run-a-task-manually">run a task manually</a> and review errors during transformation.  If there are xml access errors, compare to the original XML document, and ask if content acquisition has changed their format recently.  if there are casting errors, review the data in the original XML document again asking Content Acquisition if they&#8217;ve changed that field or element recently.</li>
</ol>
</div></blockquote>
</li>
<li><p class="first"><strong>Failure to create Redirects</strong>.  As part of imports, we create redirects for the jobs.  This involves contacting the database and inserting or updating a record.</p>
<blockquote>
<div><ol class="arabic simple">
<li><strong>Database Failures</strong>. Ensure the worker is able to access the database by using the shell to query for redirects.  If this fails, debug network issues contacting the database.  Otherwise, <a class="reference internal" href="#run-a-task-manually">run a task manually</a> and debug from exceptions.</li>
</ol>
</div></blockquote>
</li>
<li><p class="first"><strong>Failure to Save Jobs</strong>.  We upload the jobs to solr via json.  The upload process involves taking a list of dictionaries, chunking them into groups of 1024, casting them to json, and posting them to solr.</p>
<blockquote>
<div><ol class="arabic simple">
<li><strong>Check that the solr server is up</strong> and responding to requests at {{solr_server}}:8983/solr.  If it is down, investigate solr instances.</li>
<li><strong>Check access to solr from worker</strong>.  Via wget, check that wget <a class="reference external" href="http://solr_server:8983/solr/seo/select?q=*%3A*&amp;wt=json&amp;indent=true">http://solr_server:8983/solr/seo/select?q=*%3A*&amp;wt=json&amp;indent=true</a> returns.</li>
<li><strong>Check error messages from solr</strong>.  If solr is up and accessible from the worker, <a class="reference internal" href="#run-a-task-manually">run a task manually</a> on the worker to see the error message during solr.</li>
</ol>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="debugging-individual-failures">
<h2>Debugging Individual Failures:<a class="headerlink" href="#debugging-individual-failures" title="Permalink to this headline">¶</a></h2>
<p>Individual failures are much more likely to be due to the results of malformed XML than anything on our side.  With that in mind, the first step is typically to check <strong>failures while trying to load XML documents</strong> above, and <strong>failing to parse XML documents</strong> above.  Most of the time, the correct resolution for this is to identify the business unit and job that has failed, and then ask mario or Kyle to review it.  You can try <a class="reference internal" href="#run-a-task-manually">run a task manually</a> on your local box, and look at errors generated from that.</p>
</div>
<div class="section" id="running-a-task-manually">
<span id="run-a-task-manually"></span><h2>Running a Task Manually:<a class="headerlink" href="#running-a-task-manually" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>start a shell via &#8216;<code class="docutils literal"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">shell</span></code>&#8216;,</li>
<li>execute &#8216;<code class="docutils literal"><span class="pre">from</span> <span class="pre">tasks</span> <span class="pre">import</span> <span class="pre">task_etl_to_solr</span></code>&#8216;</li>
<li>execute &#8216;<code class="docutils literal"><span class="pre">task_etl_to_solr(...)</span></code>&#8216; with the parameters from a failing task.</li>
</ol>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">ETL Imports</a><ul>
<li><a class="reference internal" href="#etl-import-process">ETL Import Process:</a></li>
<li><a class="reference internal" href="#debugging-general-failures">Debugging General Failures:</a></li>
<li><a class="reference internal" href="#debugging-individual-failures">Debugging Individual Failures:</a></li>
<li><a class="reference internal" href="#running-a-task-manually">Running a Task Manually:</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Imports Documentation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../deployment/checklist.html"
                        title="next chapter">Deployment Checklist</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/developers/import_jobs/etl_imports.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../deployment/checklist.html" title="Deployment Checklist"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Imports Documentation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">My.jobs 4.6.158-13 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Developer Documentation</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Imports Documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2014, Direct Employers Association.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.3.
    </div>
  </body>
</html>